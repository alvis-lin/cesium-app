<DOCTYPE html>
  <html lang="en">
  <head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">

    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">


    <!-- custom fonts and styles for the bootstrap template -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" type="text/css" rel="stylesheet"> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"  crossorigin="anonymous">

    <link href="css/sb-admin-2.css" type="text/css" rel="stylesheet">


    <!-- cesium -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.70/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.70/Build/Cesium/Widgets/widgets.css" rel="stylesheet">



    <!-- js functionality to get ports -->
    <script src="js/utilities.js"></script> 

    <!-- js functionality to add/remove model layer to cesium globe -->
    <!-- <script src="js/modelMapLayer.js"></script>  -->

    <!-- js to check and upload form --> 
    <script src="js/cesiumCheckForm.js"></script>

    <!-- js to track latlng clicks --> 
    <script src="js/getLatlng.js"></script>







    <title>Editing in 3D</title>
    <!-- adapted from: https://blackrockdigital.github.io/startbootstrap-sb-admin-2/ -->

  </head>
  <body id="page-top">
    <div id="wrapper">

      <!-- Sidebar -->
      <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" >
          <div class="sidebar-brand-text mx-3" style="color: white">Web 3D GIS</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Nav Item - Pages Collapse Menu -->
        <!-- Nav Item - Pages Collapse Menu -->
        <!-- Adapted code for scrollable div from: https://stackoverflow.com/questions/10309268/set-div-height-auto-and-scroll-can-be-used -->

        <!-- hold form to set up quiz questions and only show on big screen (question)-->
        <!-- Adapted code for creating form: https://www.w3schools.com/tags/att_input_required.asp -->
        <li class="nav-item d-none d-lg-block" >
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            <!-- the next line is the cog image -->
            <i class="fas fa-fw fa-cog"></i>
            <span>Create Model</span>
          </a>
          <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionSidebar" style='max-height:50%; overflow-x:scroll;'>
            <div class="bg-white py-2 collapse-inner rounded">
              <!-- Adapted code for form https://1000hz.github.io/bootstrap-validator/ -->
              <form name="questionForm" data-toggle="validator" role="form">
                <div class="form-group">
                  <label for="model_name" class="control-label">Model Name</label><br>
                  <input type="text" size="20" class="form-control" id="model_name" placeholder="e.g. Pokemon Centre" required>
                </div>

                <div class="form-group">
                  <label for="latitude" class="control-label">Latitude</label><br>
                  <input type="text" size="20" id="latitude"/><br /> 
                  <label for="longitude" class="control-label">Longitude</label><br>
                  <input type="text" size="20" id="longitude"/><br />
                  <label for="altitude" class="control-label">Altitude</label><br>
                  <input type="text" size="20" id="altitude"/><br />
                  <div class="help-block with-errors">Please click on the map to get coordinates and height</div> 
                </div>

                <div class="form-group">
                  <button id="startUpload" type="button" class="btn btn-primary" onclick="submitClick()">Submit</button><br>
                  <div id="dataUploadResult">The result of the upload goes here</div>   
                </div>
              </form>
            </div>
          </div>
        </li>


        <li class="nav-item d-none d-lg-block" >
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
            <!-- the next line is the cog image -->
            <i class="fas fa-fw fa-cog"></i>
            <span>Create Line</span>
          </a>
          <div id="collapseSix" class="collapse" aria-labelledby="headingSix" data-parent="#accordionSidebar" style='max-height:50%; overflow-x:scroll;'>
            <div class="bg-white py-2 collapse-inner rounded">
              <!-- Adapted code for form https://1000hz.github.io/bootstrap-validator/ -->
              <form name="questionForm" data-toggle="validator" role="form">
                <div class="form-group">
                  <label for="line_name" class="control-label">Line Name</label><br>
                  <input type="text" size="20" class="form-control" id="line_name" placeholder="e.g. Route 1" required>
                </div>

                <div class="form-group">
                  <label for="linestring_coords" class="control-label">Linestring coordinates</label><br>
                  <input type="text" size="20" id="linestring_coords"/><br /> 
                  <div class="help-block with-errors">Please click on the map to get coordinates and height</div> 
                </div>

                <div class="form-group">
                  <button id="clearLineCoordsInput" type="button" class="btn btn-primary" onclick="clearLineCoords()">Clear input field</button>
                  <button id="startLineUpload" type="button" class="btn btn-primary" onclick="submitLineClick()">Submit</button><br>
                  <div id="lineDataUploadResult">The result of the line upload goes here</div>   
                </div>
              </form>
            </div>
          </div>
        </li>

        <li class="nav-item d-none d-lg-block" >
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSeven" aria-expanded="true" aria-controls="collapseSeven">
            <!-- the next line is the cog image -->
            <i class="fas fa-fw fa-cog"></i>
            <span>Create Polygon</span>
          </a>
          <div id="collapseSeven" class="collapse" aria-labelledby="headingSeven" data-parent="#accordionSidebar" style='max-height:50%; overflow-x:scroll;'>
            <div class="bg-white py-2 collapse-inner rounded">
              <!-- Adapted code for form https://1000hz.github.io/bootstrap-validator/ -->
              <form name="questionForm" data-toggle="validator" role="form">
                <div class="form-group">
                  <label for="polygon_name" class="control-label">Polygon Name</label><br>
                  <input type="text" size="20" class="form-control" id="polygon_name" placeholder="e.g. Pokemon School" required>
                </div>

                <div class="form-group">
                  <label for="polygon_coords" class="control-label">Polygon coordinates</label><br>
                  <input type="text" size="20" id="polygon_coords"/><br /> 
                  <div class="help-block with-errors">Please click on the map to get coordinates and height</div> 
                </div>

                <div class="form-group">
                  <button id="startPolygonUpload" type="button" class="btn btn-primary" onclick="submitPolygonClick()">Submit</button><br>
                  <div id="polygonDataUploadResult">The result of the polygon upload goes here</div>   
                </div>
              </form>
            </div>
          </div>
        </li>






        <li class="nav-item d-none d-lg-block" >
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
            <!-- the next line is the cog image -->
            <i class="fas fa-fw fa-cog"></i>
            <span>Delete Model</span>
          </a>
          <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar" style='max-height:50%; overflow-x:scroll;'>
            <div class="bg-white py-2 collapse-inner rounded">
              <!-- Adapted code for form https://1000hz.github.io/bootstrap-validator/ -->
              <form name="questionForm" data-toggle="validator" role="form">
                <div class="form-group">
                  <label for="deleteID" class="control-label">Model ID</label><br>
                  <input type="text" size="20" class="form-control" id="deleteID" placeholder="e.g. 7" required>
                </div>
                <div class="form-group">
                  <button id="startDelete" type="button" class="btn btn-primary" onclick="deleteRecord()">Delete</button><br>
                  <div id="dataDeleteResult">The result of the upload goes here</div>   
                </div>
              </form>
            </div>
          </div>
        </li>


        <!-- Divider -->
        <hr class="sidebar-divider">


        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">
            <i class="fas fa-fw fa-cog"></i>
            <span>Model Layer</span>
          </a>
          <div id="collapseFive" class="collapse" aria-labelledby="headingFive" data-parent="#accordionSidebar">
            <div class="bg-white py-2 collapse-inner rounded">
             <h6 class="collapse-header" color="white">Model</h6>
             <button id="showModelLayer" type="button" class="btn btn-primary" width="100%" onclick="showModels()">Show Models</button><br>
             <button id="hideModelLayer" type="button" class="btn btn-primary" onclick="removeModels()">Hide Models</button><br>       
            </div>
           </div>
         </li>


        <!-- cursor latlng goes to here, put "hidden" to hide it when needed-->
        <a class="sidebar-header d-flex align-items-center justify-content-center" >
          <a style="color: white">Cursor Latlng: </a>
          <div id="demo" style="z-index: 2000; color: white"></div> 
        </a>
        <hr>

        <button id="trackBtn" type="button" class="btn btn-primary" onclick="showCoords()">Show coords</button>

        <button id="editBtn" type="button" class="btn btn-primary" onclick="submitEditClick()">Edit Model</button>
        <div id="dataEditResult" style="color: white">The result of the edit goes here</div>


       </ul>
       <!-- End of Sidebar -->

       <div id="content-wrapper" class="d-flex flex-column">
        <!-- cesium div -->
        <div id="cesiumContainer" style="height: :50%"></div>
      </div>
      <!-- End of Main Content -->
    </div>
    <!-- end of wrapper -->

  </body>
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>  


  <!-- Bootstrap core JavaScript-->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="js/sb-admin-2.js"></script>



<script>
    
    // Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMjhmNWJlYy05OGM4LTQ2MTgtOTFlZC1mZTE0YmEzNDNhZmMiLCJpZCI6Mjc2MDgsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1ODk4MDk2NDV9.lPVb7dzHnqA6dSc14wNlbNTiiwNecYhMRdXub1delsk';

    // Use clipping planes to selectively hide parts of the globe surface.
    // var viewer = new Cesium.Viewer('cesiumContainer', {
    //     skyAtmosphere: false,
    //     shouldAnimate : true,
    //     terrainProvider: Cesium.createWorldTerrain()
    // });

    // a new viewer for presenting 3D data
    var viewer = new Cesium.Viewer('cesiumContainer', {
        sceneMode : Cesium.SceneMode.SCENE3D,
        timeline : false,
        animation : false
    });

    // var dataSource = Cesium.GeoJsonDataSource.load('https://developer.cege.ucl.ac.uk:30281/getGeoJSON/30281');
    // viewer.dataSources.add(dataSource);
    // viewer.zoomTo(dataSource);


    var blueBox = viewer.entities.add({
      name: "Blue box",
      position: Cesium.Cartesian3.fromDegrees(-114.0, 40.0, 300000.0),
      box: {
        dimensions: new Cesium.Cartesian3(400000.0, 300000.0, 500000.0),
        material: Cesium.Color.RED,
      },
    });



    // Loads data to map
    var dataSource3 = Cesium.GeoJsonDataSource.load('https://developer.cege.ucl.ac.uk:30281/getGeoJSON/model/location').then(
      function(dataSource3) {
        // var p = dataSource1.entities.values;
        // for (var i = 0; i < p.length; i++) {
        //   p[i].polygon.extrudedHeight = p[i].properties.height; //extrude using the height in geojson file
        // }
        viewer.dataSources.add(dataSource3);
        viewer.zoomTo(dataSource3);

        var entities = dataSource.entities.values;

        for (var i = 0; i < entities.length; i++) {
            var entity = entities[i];
            // entity.billboard = undefined;
            entity.point = new Cesium.PointGraphics({
                color: Cesium.Color.FORESTGREEN.withAlpha(0.9),
                pixelSize: 10
            });
        }
      }
    );



    // The function to show cursor latlng

    // adapted from: https://stackoverflow.com/questions/52342073/i-want-to-get-latitude-longitude-height-of-my-mouse-at-the-bottom-of-the-cesium
    // viewer.scene.canvas.addEventListener('mousemove', function(e) {
    //     var entity = viewer.entities.getById('mou');
    //     var ellipsoid = viewer.scene.globe.ellipsoid;
    //     // Mouse over the globe to see the cartographic position 
    //     var cartesian = viewer.camera.pickEllipsoid(new Cesium.Cartesian3(e.clientX, e.clientY), ellipsoid);
    //     if (cartesian) {
    //         var cartographic = ellipsoid.cartesianToCartographic(cartesian);
    //         var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(10);
    //         var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(10);
    //         entity.position = cartesian;
    //         entity.label.show = true;
    //         entity.label.font_style = 84;
    //         //entity.position= Cesium.Cartesian2.ZERO; 
    //         entity.label.text = '(' + longitudeString + ', ' + latitudeString + ')';
    //         var result = entity.label.text; // we can reuse this
    //         // document.getElementById("demo").innerHTML = entity.label.text;
    //     } else {
    //         entity.label.show = false;
    //     }
    // });


    // The function to get latlng when click on map
    // Adapted from: http://www.phpmind.com/blog/2015/11/cesiumjs-how-to-get-longitude-and-latitude-on-click/ [Accessed: 24 Jun, 2020]
    // Adapted from: https://groups.google.com/forum/#!topic/cesium-dev/kDIs_j9zKNI [Accessed: 30 Jun, 2020]
    viewer.canvas.addEventListener('click', function(e){
      var mousePosition = new Cesium.Cartesian3(e.clientX, e.clientY, e.clientZ);
   
      var ellipsoid = viewer.scene.globe.ellipsoid;
      var cartesian = viewer.camera.pickEllipsoid(mousePosition, ellipsoid);
      
      if (cartesian) {
          var cartographic = ellipsoid.cartesianToCartographic(cartesian);
          var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cartesian); // this also works
          var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(8);
          var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(8);
          //var altitudeString = Cesium.Math.toDegrees(cartographic.height).toFixed(10);
          var altitudeString = cartographic.height.toFixed(5); // The unit for height is metre, so no need to convert to degrees
   
          //alert(longitudeString + ', ' + latitudeString + ', ' + altitudeString);
          document.getElementById("latitude").value = latitudeString;
          document.getElementById("longitude").value = longitudeString;
          document.getElementById("altitude").value = altitudeString;
      } else {
          alert('Globe was not picked');
      }  
    }, false);








    // Track mouse click coordinates
    // Adapted from: https://stackoverflow.com/questions/36925075/save-mouse-coordinate-in-an-array [Accessed on 6 July, 2020]

    viewer.canvas.addEventListener('click', handleClick, false);

    // // array to store click coords
    var clickCoords = [];

    // // // a point coord
    var ClickPoint = function(x, y, z) {
      this.x = x;
      this.y = y;
      this.z = z;
    };

    // // // change the string format
    ClickPoint.prototype.toString = function(){
       return this.x + " " + this.y + " " + this.z;
    }

    function handleClick(e) {
      var mousePosition = new Cesium.Cartesian3(e.clientX, e.clientY, e.clientZ);
   
      var ellipsoid = viewer.scene.globe.ellipsoid;
      var cartesian = viewer.camera.pickEllipsoid(mousePosition, ellipsoid);


      if (cartesian) {
          var cartographic = ellipsoid.cartesianToCartographic(cartesian); //original
          var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(cartesian); // this is for testting
          var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(8);
          var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(8);
          var altitudeString = cartographic.height.toFixed(5); // The unit for height is metre, so no need to convert to degrees
  

          // create click point and store it in array
          var aClick = new ClickPoint(longitudeString, latitudeString, altitudeString);
          clickCoords.push(aClick); // added comma to seperate 

          // update results
          showArrayCoords(clickCoords);
          } else {
            alert('Globe was not picked');
         }
    }

    function showArrayCoords(coords) {
      // To update coords for linestring
      var innerHtml = '';
      for (i = 0; i < coords.length; i++) {
        innerHtml += coords[i] + ', ';
      }
      innerHtml = innerHtml.slice(0, -2);

      // To update coords for polygon
      var poly_innerHtml = '';
      for (i = 0; i < coords.length; i++) {
        poly_innerHtml += coords[i] + ', ';
      }
      poly_innerHtml += coords[0] // The first and last point of polygon should be the same point

      document.getElementById("linestring_coords").value = innerHtml; //parse linestring coords back to webpage
      document.getElementById("polygon_coords").value = poly_innerHtml; //parse polygon coords back to webpage
      alert(innerHtml);
    }





    

    // var viewer = new Cesium.Viewer('cesiumContainer');
    // function to zoom to user location
    // from: https://groups.google.com/forum/#!topic/cesium-dev/VDaXd0oODhs
    // function fly(position) {
    //     var source = new Cesium.CustomDataSource();
    //     viewer.dataSources.add(source);
    //     var entity = source.entities.add({
    //         position : Cesium.Cartesian3.fromDegrees(position.coords.longitude, position.coords.latitude),
    //         ellipse : {
    //             semiMajorAxis : 100.0,
    //             semiMinorAxis : 100.0,
    //             material : new Cesium.ColorMaterialProperty(new Cesium.Color(0.2, 0.2, 1.0, 0.5))
    //         },

    //         // Can't load images for some reasons
    //         // billboard : {
    //         //     image : '../Cesium Code/image/pin.png',
    //         //     imageSubRegion : new Cesium.BoundingRectangle(49, 43, 18, 18),
    //         //     color : Cesium.Color.LIME
    //         // },

    //         // This worked but is at the bottom of the ellipse
    //         label : {
    //             text: 'You are here',
    //             verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
    //             show: false
    //         }
    //     });

    //     function showLabel() {
    //         entity.label.show = true;
    //     }

    //     viewer.camera.flyTo({
    //         destination : Cesium.Cartesian3.fromDegrees(position.coords.longitude, position.coords.latitude, 1005.0),
    //         complete: showLabel
    //     });
    // }
    // // Ask browser for location, and fly there.
    // navigator.geolocation.getCurrentPosition(fly);



    // //load the Leaflet map and then add the data AFTER the page has loaded
    document.addEventListener('DOMContentLoaded', function() { 
      loadMap(); 
    }, false); 

    // to load map and add earthquake data
    function loadMap() { 
      getPorts(); 
    } 


</script>

</html>
